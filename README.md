# 摄像头测距

## 一、项目功能

本项目是一个基于Quectel pi H1单板电脑实现的摄像头测距应用，提供以下功能：

### 1. 双目摄像头预览（辅助功能，用于观察左右目摄像头的预览是否正常）
- 支持左/右摄像头单独预览
- 实时显示摄像头画面
- 自动检测并适配双目摄像头

### 2. 双目拍照（辅助功能，同时使用左右目摄像头拍照观察是否有偏移）
- 同时捕获左右摄像头的图像
- 自动分割左右画面
- 保存到指定路径

### 3. 双目测距（主要功能，用左目摄像头当预览画面，屏幕点击进行测距）
- 基于视差原理计算目标距离
- 点击画面任意位置即可测距
- 使用SGBM立体匹配算法
- 支持标定参数优化测量精度

### 4. 摄像头参数设置（辅助功能，用于调节摄像头参数）
- 亮度、对比度、饱和度调节
- 曝光时间/自动曝光
- 白平衡/自动白平衡
- 伽马、锐度、背光补偿

---

## 二、环境配置

### 2.1 系统要求
- **操作系统**: Linux（使用V4L2接口）
- **Python版本**: 3.8+
- **OpenCV版本**: 4.8+
- **PySide6版本**: 6.5+
- **numpy版本**: 1.24+

### 2.2 依赖安装

```bash
pip install -r requirements.txt
```

或手动安装：

```bash
pip install PySide6>=6.5.0
pip install opencv-python>=4.8.0
pip install numpy>=1.24.0
```

### 2.3 系统依赖（Linux）
```bash
# V4L2工具（用于摄像头参数读取）
sudo apt-get install v4l-utils
```

---

## 三、项目代码结构简介

```
PyCameraDemo/
├── main.py                 # 主入口，启动GUI应用
├── camera_manager.py       # 摄像头管理类，负责视频采集、预览、拍照
├── camera_calibration.py   # 双目标定模块，采集标定图像并计算参数
├── ranging_calculator.py   # 测距计算器，基于视差计算距离
├── ui_manager.py           # UI界面管理，PySide6 GUI实现
├── common.py               # 公共配置、全局状态管理、摄像头自动检测
├── requirements.txt        # Python依赖列表
└── stereo_calib_params.npz # 标定参数文件（运行标定后生成）
```

### 3.1 模块说明

| 文件 | 功能描述 |
|------|----------|
| `main.py` | 应用程序入口，初始化Qt应用并显示主窗口 |
| `camera_manager.py` | `CameraManager`类：摄像头预览线程、参数设置、双目拍照 |
| `camera_calibration.py` | 标定流程：采集棋盘格图像→角点检测→双目标定→参数保存 |
| `ranging_calculator.py` | `RangingCalculator`类：加载标定参数、计算视差图、计算距离 |
| `ui_manager.py` | `UIManager`类：主界面、预览页、拍照页、测距页、设置页 |
| `common.py` | 全局配置（分辨率、设备路径）、`GlobalState`单例状态管理 |

## 四、硬件要求

### 4.1 双目摄像头（规格不硬性要求，以下是本项目使用规格）
- **接口类型**: USB
- **分辨率要求**: 
  - 推荐分辨率: 2560×720（左右各1280×720）
  - 支持其他宽高比 ≥ 1.8 的双目摄像头
- **帧率**: 支持15fps以上
- **输出格式**: YUYV/MJPG

### 4.2 标定工具
- **棋盘格标定板**: 9×6 内角点
- **方格边长**: 约9mm（可用手机屏幕显示，具体长度根据实际情况调整）

### 4.3 运行环境
- **开发板/PC**: 支持USB摄像头
- **内存**: 建议2GB以上
- **GPU**: 不要求（纯CPU计算）

---

## 五、使用方法

### 5.1 摄像头标定（首次使用）
```bash
# 1. 修改 camera_calibration.py，取消 capture_calibration_images() 注释
# 2. 运行标定程序，按 's' 保存图像对（至少10对）
# 3. 按 'q' 退出采集
# 4. 取消 calibrate_stereo_camera() 注释，运行标定计算
python camera_calibration.py
```

### 5.2 运行主程序
```bash
python main.py
```


### 5.3 测距操作
1. 点击"Start Ranging Mode"进入测距页面
2. 在画面上点击目标位置
4. 等待距离计算结果显示

**测距结果显示：**

![测距结果显示](test1.png)

---

## 六、技术原理

### 6.1 双目测距原理
```
距离 Z = (f × B) / d

其中:
- f: 焦距（像素）
- B: 基线距离（米）
- d: 视差（像素）
```

### 6.2 算法流程
1. 左右图像采集
2. 立体校正（基于标定参数）
3. SGBM视差计算
4. 视差转3D坐标
5. 提取目标点距离
